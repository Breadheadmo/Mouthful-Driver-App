// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {
    ext {
        buildToolsVersion = "35.0.0"
        minSdkVersion = 24
        compileSdkVersion = 35
        targetSdkVersion = 35
        supportLibVersion = "28.0.0"
        googlePlayServicesAuthVersion = "16.0.1"
        androidXAnnotation = "1.2.0"
        androidXBrowser = "1.3.0"
        kotlinVersion = "1.9.10"

        // We use NDK 23 which has both M1 support and is the side-by-side NDK version from AGP.
        ndkVersion = "23.1.7779620"
    }
    repositories {
        google()
        mavenCentral()
        mavenCentral()
    }
    dependencies {
        classpath("com.android.tools.build:gradle:8.1.1")
        classpath("com.facebook.react:react-native-gradle-plugin")
        classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
        classpath 'com.google.gms:google-services:4.4.0'
        // NOTE: Do not place your application dependencies here; they belong
        // in the individual module build.gradle files
    }
}

allprojects {
    repositories {
        maven {
            // All of React Native (JS, Obj-C sources, Android binaries) is installed from npm
            url("$rootDir/../node_modules/react-native/android")
        }
        maven {
            // Android JSC is installed from npm
            url("$rootDir/../node_modules/jsc-android/dist")
        }
        maven {
            // expo-camera bundles a custom com.google.android:cameraview
            url "$rootDir/../node_modules/expo-camera/android/maven"
        }
        google()
        mavenCentral()
        maven { url 'https://maven.google.com' }
        maven { url 'https://www.jitpack.io' } 
        jcenter() {
            content {
               includeModule("com.danikula", "videocache")
            }
        }
    }
}

subprojects { subproject ->
    afterEvaluate {
        if (subproject.plugins.hasPlugin('com.android.application') ||
            subproject.plugins.hasPlugin('com.android.library')) {
            subproject.android {
                compileSdkVersion rootProject.ext.compileSdkVersion
                
                buildFeatures {
                    buildConfig = true
                }
                
                // Only set Java 17 for main app, let modules use their own settings
                if (subproject.name == 'app') {
                    compileOptions {
                        sourceCompatibility = JavaVersion.VERSION_17
                        targetCompatibility = JavaVersion.VERSION_17
                    }
                }
                
                // Set namespace for modules that don't have it
                if (!subproject.android.hasProperty('namespace') || subproject.android.namespace == null) {
                    if (subproject.name.startsWith('expo-')) {
                        subproject.android.namespace = "expo.modules.${subproject.name.replace('expo-', '').replace('-', '')}"
                    } else if (subproject.name.startsWith('react-native-')) {
                        subproject.android.namespace = "com.reactnative.${subproject.name.replace('react-native-', '').replace('-', '').replace('_', '')}"
                    } else {
                        subproject.android.namespace = "com.${subproject.name.replace('-', '').replace('_', '')}"
                    }
                }
            }
        }
        
        // Fix for react-native-google-signin task dependencies (AGP 8.2.0 compatible)
        if (subproject.name.contains('react-native-google-signin')) {
            subproject.tasks.whenTaskAdded { task ->
                if (task.name == 'packageDebugResources') {
                    // Only depend on tasks that exist
                    def generateDebugResValues = subproject.tasks.findByName('generateDebugResValues')
                    if (generateDebugResValues) {
                        task.dependsOn generateDebugResValues
                    }
                }
                if (task.name == 'packageReleaseResources') {
                    // Only depend on tasks that exist
                    def generateReleaseResValues = subproject.tasks.findByName('generateReleaseResValues')
                    if (generateReleaseResValues) {
                        task.dependsOn generateReleaseResValues
                    }
                }
                // Fix for release build JNI libs task dependency
                if (task.name == 'copyReleaseJniLibsProjectAndLocalJars') {
                    def stripTask = subproject.tasks.findByName('stripReleaseDebugSymbols')
                    if (stripTask) {
                        task.dependsOn stripTask
                    }
                }
            }
        }
        
        // Fix for Kotlin compilation - set JVM target for Kotlin modules
        subproject.tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
            kotlinOptions {
                // Use Java 11 for most modules, Java 17 for app
                jvmTarget = subproject.name == 'app' ? "17" : "11"
            }
        }
    }
}
